{"componentChunkName":"component---src-templates-course-content-template-js","path":"/part-3/1-introduction-to-gke","result":{"data":{"page":{"htmlAst":{"type":"element","tagName":"div","properties":{},"children":[{"type":"element","tagName":"text-box","properties":{"variant":"learningObjectives","name":"Learning Objectives"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"After this section you can"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Create your own cluster in GKE"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Deploy applications to Google Kubernetes Engine"}]},{"type":"text","value":"\n"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We have used Kubernetes distribution k3s using docker containers via k3d. In a production environment the task of maintaining a Kubernetes cluster is often left to third parties. A managed Kubernetes as a service is often the best choice as the additional work required in maintenance exceeds the benefits of a personal cluster. In some, somewhat rare, cases setting up and maintaining your own cluster is a reasonable option. A case for it would be that your company/organization already has the hardware and/or wants to stay independent from providers, one such example could be a University. Another primary reason for operating your own Kubernetes cluster is that regulations rule out all other choices."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Maintaining your own Kubernetes cluster is one way to increase costs. The other is running servers that are not in use. To avoid costs "},{"type":"element","tagName":"a","properties":{"href":"https://en.wikipedia.org/wiki/Serverless_computing","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Serverless"}]},{"type":"text","value":" solutions could be more cost-efficient. A Kubernetes cluster of improper size can get really expensive really fast. An excellent option to start out with would be a high-tier environment for serverless workloads, such as Google Cloud Run or AWS Fargate. In them you can run any container, compared to older solutions like Cloud Functions or AWS Lambda, which have a wildly varying support for different languages, environments and tooling."}]},{"type":"comment","value":"-\n<text-box variant='hint' name='Registration for Open University students'>\n  If you are student in Finland, a student with finnish social security number or a student at the University of Helsinki register for the course now. Follow the <a href=\"/registration-and-completion\">instructions</a> to receive Google Cloud Platform Education Grant.\n</text-box>\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Let's focus on the Google Kubernetes Engine (GKE) costs for now. Note that the GKE costs a little bit more than its competitors."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The calculator here "},{"type":"element","tagName":"a","properties":{"href":"https://cloud.google.com/products/calculator","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://cloud.google.com/products/calculator"}]},{"type":"text","value":" offers us a picture of the pricing. I decided to try a cheap option: 6 nodes in 1 zonal cluster using 1 vCPU each. The datacenter location is in Finland and I don't need a persistent disk. If we wanted less than 6 nodes why would we even use Kubernetes? The total cost for this example was ~145€ / ~$160 per month. Adding additional services such as a Load balancer increase the cost. If you find the billing for Google Cloud Platform confusing, you're not alone: Coursera has ~5 hour course for \""},{"type":"element","tagName":"a","properties":{"href":"https://www.coursera.org/learn/gcp-cost-management","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Understanding Your Google Cloud Platform Costs"}]},{"type":"text","value":"\"."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"During part 3 we will be using GKE either by using the student credits available to students with helsinki.fi email or the free credits offered by Google. You are responsible for making sure that the credits last for the whole part and if all of them are consumed I can not help you."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"After redeeming the credits we can create a project with the billing account. The Google Cloud UI can be confusing. On the "},{"type":"element","tagName":"a","properties":{"href":"https://console.cloud.google.com/cloud-resource-manager","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"resources page"}]},{"type":"text","value":" we can create a new project and let's name it \"dwk-gke\" for the purposes of this course. After creating this project make sure that the project is linked to the correct billing account from the top-left dropdown and billing and then \"Account Management\". It should look like this (In this case the account is \"DevOps with Kubernetes\" and project \"dwk-gke\"):"}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 32.173913043478265%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/klEQVR42nWOy07DMBBF8/9igdgAaoRKvoANUhcQUsp/sIQqJLbH8dvNxXaoVBUY6djWeO6xq4uHd6zaHvc7jrpjuNrscfn4gZuWYb0dcNfu0bx+odkRbp/TzItA80aotwurjrBOd3UncP3EUXnNgKAB+IWYzy4RE/MPf1SaM3KEVyNwMKkRChUXBEES1nkY6zCMHIwTJqUR44xD8sW0nJJ7I1l8DgpKG2hjSzZTEREYYzDGIIRQiDFinpef5f2cXFpr5Owx472Hc0koSUBKgne2iI51Gj6X55qmCX3fQylV5NbaIq4GrtCPE4R0cD78Cv4nzAIhRIFzXh7Iv/wGhBnJ3AL/XbIAAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/295165a36ca6546efbb75b5fafbb43f5/a0b58/gke_billing.webp 230w","/static/295165a36ca6546efbb75b5fafbb43f5/bc10c/gke_billing.webp 460w","/static/295165a36ca6546efbb75b5fafbb43f5/966d8/gke_billing.webp 920w","/static/295165a36ca6546efbb75b5fafbb43f5/445df/gke_billing.webp 1380w","/static/295165a36ca6546efbb75b5fafbb43f5/e12b1/gke_billing.webp 1438w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/295165a36ca6546efbb75b5fafbb43f5/81c8e/gke_billing.png 230w","/static/295165a36ca6546efbb75b5fafbb43f5/08a84/gke_billing.png 460w","/static/295165a36ca6546efbb75b5fafbb43f5/c0255/gke_billing.png 920w","/static/295165a36ca6546efbb75b5fafbb43f5/b1001/gke_billing.png 1380w","/static/295165a36ca6546efbb75b5fafbb43f5/a6ec4/gke_billing.png 1438w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/295165a36ca6546efbb75b5fafbb43f5/c0255/gke_billing.png","alt":"gke billing","title":"gke billing","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Install the Google Cloud SDK. Instructions "},{"type":"element","tagName":"a","properties":{"href":"https://cloud.google.com/sdk/install","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"here"}]},{"type":"text","value":". After that login and set the previously created project to be used."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ gcloud -v\n  Google Cloud SDK 363.0.0\n  bq 2.0.71\n  core 2021.10.29\n  gsutil 5.4\n\n$ gcloud auth login\n  ...\n  You are now logged in\n\n$ gcloud config set project dwk-gke\n  Updated property [core/project]."}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We can now create a cluster. You can choose any zone we want from the list "},{"type":"element","tagName":"a","properties":{"href":"https://cloud.google.com/about/locations/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"here"}]},{"type":"text","value":". I chose Finland. Notice that one region (e.g. europe-north1) may have multiple regions (e.g. -a). Let's add another flag: "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"--cluster-version=1.22"}]},{"type":"text","value":". This will ask GKE to use a version that will be default in June 2022. "},{"type":"element","tagName":"a","properties":{"href":"https://cloud.google.com/kubernetes-engine/docs/release-schedule","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"GKE release schedule here"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ gcloud container clusters create dwk-cluster --zone=europe-north1-b --cluster-version=1.22\nERROR: (gcloud.container.clusters.create) ResponseError: code=400, message=Failed precondition when calling the ServiceConsumerManager: tenantmanager:: Consumer should enable service:container.googleapis.com before generating a service account."}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Let's enable the service in question, "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"container.googleapis.com"}]},{"type":"text","value":", before retrying."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ gcloud services enable container.googleapis.com\n  Operation \"operations/acf.p2-385245615727-2f855eed-e785-49ac-91da-896925a691ab\" finished successfully.\n\n$ gcloud container clusters create dwk-cluster --zone=europe-north1-b --cluster-version=1.22\n  ...\n  Creating cluster dwk-cluster in europe-north1-b...\n  ...\n  kubeconfig entry generated for dwk-cluster.\n  NAME         LOCATION         MASTER_VERSION   MASTER_IP       MACHINE_TYPE  NODE_VERSION     NUM_NODES  STATUS\n  dwk-cluster  europe-north1-b  1.22.8-gke.2200  35.228.176.118  e2-medium     1.22.8-gke.2200  3          RUNNING"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"It set the kubeconfig to point in the right direction already. But if you need to do it again we can set the kubeconfig like this:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ gcloud container clusters get-credentials dwk-cluster --zone=europe-north1-b\n  Fetching cluster endpoint and auth data.\n  kubeconfig entry generated for dwk-cluster."}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"You can check the cluster info with "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"kubectl cluster-info"}]},{"type":"text","value":" to verify it's pointing in the right direction."}]},{"type":"element","tagName":"h3","properties":{"id":"deploying-to-gke","style":"position:relative;"},"children":[{"type":"text","value":"Deploying to GKE"},{"type":"element","tagName":"a","properties":{"href":"#deploying-to-gke","ariaLabel":"deploying to gke permalink","className":["anchor","after"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The cluster we have now is "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"almost"}]},{"type":"text","value":" like the one we had locally. Let's apply this application that creates a random string and then serves an image based on that random string. This will create 6 replicas of the process \"seedimage\"."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ kubectl apply -f https://raw.githubusercontent.com/kubernetes-hy/material-example/e11a700350aede132b62d3b5fd63c05d6b976394/app6/manifests/deployment.yaml"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Exposing the service is where the differences start. Instead of an ingress we'll use "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"LoadBalancer"}]},{"type":"text","value":" service. Now as a warning the next step is going to add into the "},{"type":"element","tagName":"a","properties":{"href":"https://cloud.google.com/compute/all-pricing#lb","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"cost of the cluster"}]},{"type":"text","value":" as well."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Apply the following:"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"service.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Service\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" seedimage"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"svc\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"type"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" LoadBalancer "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# This should be the only unfamiliar part"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"selector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" seedimage\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"ports"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"port"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"80"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"protocol"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" TCP\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"targetPort"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"3000"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"A load balancer service asks for Google services to provision us a load balancer. We can wait until the service gets an external IP:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ kubectl get svc --watch\n  NAME            TYPE           CLUSTER-IP      EXTERNAL-IP    PORT(S)        AGE\n  kubernetes      ClusterIP      10.31.240.1     <none>         443/TCP        144m\n  seedimage-svc   LoadBalancer   10.31.241.224   35.228.41.16   80:30215/TCP   94s"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"If we now access "},{"type":"element","tagName":"a","properties":{"href":"http://35.228.41.16","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"http://35.228.41.16"}]},{"type":"text","value":" with our browser we'll see the application up and running. By refreshing the page we can also see that the load balancer sometimes offers us a different image. Note that this is available in port 80, so https will not work."}]},{"type":"element","tagName":"div","properties":{"className":["highlight-box"],"markdown":"1"},"children":[{"type":"text","value":"\nTo avoid using up the credits delete the cluster whenever you do not need it"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ gcloud container clusters delete dwk-cluster --zone=europe-north1-b"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"And when resuming progress create the cluster back."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ gcloud container clusters create dwk-cluster --zone=europe-north1-b --cluster-version=1.22"}]}]}]},{"type":"element","tagName":"div","properties":{},"children":[{"type":"text","value":"Closing the cluster will also remove everything you've deployed on the cluster. If you decide to take a break during an example you may have to redo it. Thankfully we have used a declarative approach so continuing progress will only require you to apply the yamls.\n"}]},{"type":"element","tagName":"h3","properties":{"id":"persisting-data-in-gke","style":"position:relative;"},"children":[{"type":"text","value":"Persisting data in GKE"},{"type":"element","tagName":"a","properties":{"href":"#persisting-data-in-gke","ariaLabel":"persisting data in gke permalink","className":["anchor","after"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Google Kubernetes Engine will automatically provision a persistent disk for your PersistentVolumeClaim - just don't set the storage class. If you want you can read more about it "},{"type":"element","tagName":"a","properties":{"href":"https://cloud.google.com/kubernetes-engine/docs/concepts/persistent-volumes","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"here"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"exercise","properties":{"name":"Exercise 3.01: Pingpong GKE"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  Deploy ping / pong application into GKE."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  In this exercise use a LoadBalancer service to expose the service."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  If your postgres logs say"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"initdb: error: directory \"/var/lib/postgresql/data\" exists but is not empty\nIt contains a lost+found directory, perhaps due to it being a mount point.\nUsing a mount point directly as the data directory is not recommended.\nCreate a subdirectory under the mount point."}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  you can add subPath configuration:"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"statefulset.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ..."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"volumeMounts"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" data\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"mountPath"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" /var/lib/postgresql/data\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"subPath"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" postgres\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ..."}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  This will create a postgres directory where the data will reside. subPaths also make it possible to use single volume for multiple purposes."}]}]},{"type":"element","tagName":"h3","properties":{"id":"from-service-to-ingress","style":"position:relative;"},"children":[{"type":"text","value":"From Service to Ingress"},{"type":"element","tagName":"a","properties":{"href":"#from-service-to-ingress","ariaLabel":"from service to ingress permalink","className":["anchor","after"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Services are quite simple. Let's try using ingress since it offers us additional tools in exchange for complexity."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"NodePort"}]},{"type":"text","value":" type service is required with an Ingress in GKE. Even though it is NodePort, GKE does not expose it outside the cluster. Let's test this by continuing with the previous example."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"service.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Service\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" seedimage"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"svc\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"type"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" NodePort\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"selector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" seedimage\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"ports"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"port"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"80"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"protocol"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" TCP\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"targetPort"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"3000"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"ingress.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" networking.k8s.io/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Ingress\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" seedimage"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"ing\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"rules"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"http"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"paths"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"path"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" /\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"pathType"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Prefix\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"backend"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"service"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" seedimage"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"svc\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"port"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"number"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"80"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"When you have applied those you can view the port from the list of ingresses:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"$ kubectl get ing\n  NAME            CLASS    HOSTS   ADDRESS         PORTS   AGE\n  seedimage-ing   <none>   *       34.120.61.234   80      2m13s"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now the address here will be the way to access the application. This will take a moment to deploy, responses may be 404 and 502 as it becomes available. The Ingress performs health checks by GET requesting / and expects an HTTP 200 response."}]},{"type":"element","tagName":"exercise","properties":{"name":"Exercise 3.02: Back to Ingress"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  Deploy the \"Log output\" and \"Ping-pong\" applications into GKE and expose it with Ingress."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  \"Ping-pong\" will have to respond from /pingpong path. This may require you to rewrite parts of the code."}]}]},{"type":"element","tagName":"div","properties":{},"children":[{"type":"element","tagName":"quiz","properties":{"id":"419b91fc-769c-4964-b679-e7790f70799b"},"children":[]}]}]}]},"html":"<div><text-box variant='learningObjectives' name='Learning Objectives'><p>After this section you can</p><ul>\n<li>Create your own cluster in GKE</li>\n<li>Deploy applications to Google Kubernetes Engine</li>\n</ul></text-box><p>We have used Kubernetes distribution k3s using docker containers via k3d. In a production environment the task of maintaining a Kubernetes cluster is often left to third parties. A managed Kubernetes as a service is often the best choice as the additional work required in maintenance exceeds the benefits of a personal cluster. In some, somewhat rare, cases setting up and maintaining your own cluster is a reasonable option. A case for it would be that your company/organization already has the hardware and/or wants to stay independent from providers, one such example could be a University. Another primary reason for operating your own Kubernetes cluster is that regulations rule out all other choices.</p><p>Maintaining your own Kubernetes cluster is one way to increase costs. The other is running servers that are not in use. To avoid costs <a href=\"https://en.wikipedia.org/wiki/Serverless_computing\" target=\"_blank\" rel=\"noopener noreferrer\">Serverless</a> solutions could be more cost-efficient. A Kubernetes cluster of improper size can get really expensive really fast. An excellent option to start out with would be a high-tier environment for serverless workloads, such as Google Cloud Run or AWS Fargate. In them you can run any container, compared to older solutions like Cloud Functions or AWS Lambda, which have a wildly varying support for different languages, environments and tooling.</p><!---\n<text-box variant='hint' name='Registration for Open University students'>\n  If you are student in Finland, a student with finnish social security number or a student at the University of Helsinki register for the course now. Follow the <a href=\"/registration-and-completion\">instructions</a> to receive Google Cloud Platform Education Grant.\n</text-box>\n--><p>Let's focus on the Google Kubernetes Engine (GKE) costs for now. Note that the GKE costs a little bit more than its competitors.</p><p>The calculator here <a href=\"https://cloud.google.com/products/calculator\" target=\"_blank\" rel=\"noopener noreferrer\">https://cloud.google.com/products/calculator</a> offers us a picture of the pricing. I decided to try a cheap option: 6 nodes in 1 zonal cluster using 1 vCPU each. The datacenter location is in Finland and I don't need a persistent disk. If we wanted less than 6 nodes why would we even use Kubernetes? The total cost for this example was ~145€ / ~$160 per month. Adding additional services such as a Load balancer increase the cost. If you find the billing for Google Cloud Platform confusing, you're not alone: Coursera has ~5 hour course for \"<a href=\"https://www.coursera.org/learn/gcp-cost-management\" target=\"_blank\" rel=\"noopener noreferrer\">Understanding Your Google Cloud Platform Costs</a>\".</p><p>During part 3 we will be using GKE either by using the student credits available to students with helsinki.fi email or the free credits offered by Google. You are responsible for making sure that the credits last for the whole part and if all of them are consumed I can not help you.</p><p>After redeeming the credits we can create a project with the billing account. The Google Cloud UI can be confusing. On the <a href=\"https://console.cloud.google.com/cloud-resource-manager\" target=\"_blank\" rel=\"noopener noreferrer\">resources page</a> we can create a new project and let's name it \"dwk-gke\" for the purposes of this course. After creating this project make sure that the project is linked to the correct billing account from the top-left dropdown and billing and then \"Account Management\". It should look like this (In this case the account is \"DevOps with Kubernetes\" and project \"dwk-gke\"):</p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 32.173913043478265%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/klEQVR42nWOy07DMBBF8/9igdgAaoRKvoANUhcQUsp/sIQqJLbH8dvNxXaoVBUY6djWeO6xq4uHd6zaHvc7jrpjuNrscfn4gZuWYb0dcNfu0bx+odkRbp/TzItA80aotwurjrBOd3UncP3EUXnNgKAB+IWYzy4RE/MPf1SaM3KEVyNwMKkRChUXBEES1nkY6zCMHIwTJqUR44xD8sW0nJJ7I1l8DgpKG2hjSzZTEREYYzDGIIRQiDFinpef5f2cXFpr5Owx472Hc0koSUBKgne2iI51Gj6X55qmCX3fQylV5NbaIq4GrtCPE4R0cD78Cv4nzAIhRIFzXh7Iv/wGhBnJ3AL/XbIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/295165a36ca6546efbb75b5fafbb43f5/a0b58/gke_billing.webp 230w,\n/static/295165a36ca6546efbb75b5fafbb43f5/bc10c/gke_billing.webp 460w,\n/static/295165a36ca6546efbb75b5fafbb43f5/966d8/gke_billing.webp 920w,\n/static/295165a36ca6546efbb75b5fafbb43f5/445df/gke_billing.webp 1380w,\n/static/295165a36ca6546efbb75b5fafbb43f5/e12b1/gke_billing.webp 1438w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/webp\">\n        <source srcset=\"/static/295165a36ca6546efbb75b5fafbb43f5/81c8e/gke_billing.png 230w,\n/static/295165a36ca6546efbb75b5fafbb43f5/08a84/gke_billing.png 460w,\n/static/295165a36ca6546efbb75b5fafbb43f5/c0255/gke_billing.png 920w,\n/static/295165a36ca6546efbb75b5fafbb43f5/b1001/gke_billing.png 1380w,\n/static/295165a36ca6546efbb75b5fafbb43f5/a6ec4/gke_billing.png 1438w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/295165a36ca6546efbb75b5fafbb43f5/c0255/gke_billing.png\" alt=\"gke billing\" title=\"gke billing\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n    </span><p>Install the Google Cloud SDK. Instructions <a href=\"https://cloud.google.com/sdk/install\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>. After that login and set the previously created project to be used.</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ gcloud -v\n  Google Cloud SDK 363.0.0\n  bq 2.0.71\n  core 2021.10.29\n  gsutil 5.4\n\n$ gcloud auth login\n  ...\n  You are now logged in\n\n$ gcloud config set project dwk-gke\n  Updated property [core/project].</code></pre></div><p>We can now create a cluster. You can choose any zone we want from the list <a href=\"https://cloud.google.com/about/locations/\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>. I chose Finland. Notice that one region (e.g. europe-north1) may have multiple regions (e.g. -a). Let's add another flag: <code class=\"language-text\">--cluster-version=1.22</code>. This will ask GKE to use a version that will be default in June 2022. <a href=\"https://cloud.google.com/kubernetes-engine/docs/release-schedule\" target=\"_blank\" rel=\"noopener noreferrer\">GKE release schedule here</a>.</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ gcloud container clusters create dwk-cluster --zone=europe-north1-b --cluster-version=1.22\nERROR: (gcloud.container.clusters.create) ResponseError: code=400, message=Failed precondition when calling the ServiceConsumerManager: tenantmanager:: Consumer should enable service:container.googleapis.com before generating a service account.</code></pre></div><p>Let's enable the service in question, <code class=\"language-text\">container.googleapis.com</code>, before retrying.</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ gcloud services enable container.googleapis.com\n  Operation &quot;operations/acf.p2-385245615727-2f855eed-e785-49ac-91da-896925a691ab&quot; finished successfully.\n\n$ gcloud container clusters create dwk-cluster --zone=europe-north1-b --cluster-version=1.22\n  ...\n  Creating cluster dwk-cluster in europe-north1-b...\n  ...\n  kubeconfig entry generated for dwk-cluster.\n  NAME         LOCATION         MASTER_VERSION   MASTER_IP       MACHINE_TYPE  NODE_VERSION     NUM_NODES  STATUS\n  dwk-cluster  europe-north1-b  1.22.8-gke.2200  35.228.176.118  e2-medium     1.22.8-gke.2200  3          RUNNING</code></pre></div><p>It set the kubeconfig to point in the right direction already. But if you need to do it again we can set the kubeconfig like this:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ gcloud container clusters get-credentials dwk-cluster --zone=europe-north1-b\n  Fetching cluster endpoint and auth data.\n  kubeconfig entry generated for dwk-cluster.</code></pre></div><p>You can check the cluster info with <code class=\"language-text\">kubectl cluster-info</code> to verify it's pointing in the right direction.</p><h3 id=\"deploying-to-gke\" style=\"position:relative;\">Deploying to GKE<a href=\"#deploying-to-gke\" aria-label=\"deploying to gke permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3><p>The cluster we have now is <em>almost</em> like the one we had locally. Let's apply this application that creates a random string and then serves an image based on that random string. This will create 6 replicas of the process \"seedimage\".</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ kubectl apply -f https://raw.githubusercontent.com/kubernetes-hy/material-example/e11a700350aede132b62d3b5fd63c05d6b976394/app6/manifests/deployment.yaml</code></pre></div><p>Exposing the service is where the differences start. Instead of an ingress we'll use <em>LoadBalancer</em> service. Now as a warning the next step is going to add into the <a href=\"https://cloud.google.com/compute/all-pricing#lb\" target=\"_blank\" rel=\"noopener noreferrer\">cost of the cluster</a> as well.</p><p>Apply the following:</p><p><strong>service.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> seedimage<span class=\"token punctuation\">-</span>svc\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> LoadBalancer <span class=\"token comment\"># This should be the only unfamiliar part</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> seedimage\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3000</span></code></pre></div><p>A load balancer service asks for Google services to provision us a load balancer. We can wait until the service gets an external IP:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ kubectl get svc --watch\n  NAME            TYPE           CLUSTER-IP      EXTERNAL-IP    PORT(S)        AGE\n  kubernetes      ClusterIP      10.31.240.1     &lt;none&gt;         443/TCP        144m\n  seedimage-svc   LoadBalancer   10.31.241.224   35.228.41.16   80:30215/TCP   94s</code></pre></div><p>If we now access <a href=\"http://35.228.41.16\" target=\"_blank\" rel=\"noopener noreferrer\">http://35.228.41.16</a> with our browser we'll see the application up and running. By refreshing the page we can also see that the load balancer sometimes offers us a different image. Note that this is available in port 80, so https will not work.</p><div class=\"highlight-box\" markdown=\"1\">\nTo avoid using up the credits delete the cluster whenever you do not need it<div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ gcloud container clusters delete dwk-cluster --zone=europe-north1-b</code></pre></div><p>And when resuming progress create the cluster back.</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ gcloud container clusters create dwk-cluster --zone=europe-north1-b --cluster-version=1.22</code></pre></div><div>Closing the cluster will also remove everything you've deployed on the cluster. If you decide to take a break during an example you may have to redo it. Thankfully we have used a declarative approach so continuing progress will only require you to apply the yamls.\n</exercise></div><h3 id=\"persisting-data-in-gke\" style=\"position:relative;\">Persisting data in GKE<a href=\"#persisting-data-in-gke\" aria-label=\"persisting data in gke permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3><p>Google Kubernetes Engine will automatically provision a persistent disk for your PersistentVolumeClaim - just don't set the storage class. If you want you can read more about it <a href=\"https://cloud.google.com/kubernetes-engine/docs/concepts/persistent-volumes\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>.</p><exercise name='Exercise 3.01: Pingpong GKE'><p>  Deploy ping / pong application into GKE.</p><p>  In this exercise use a LoadBalancer service to expose the service.</p><p>  If your postgres logs say</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">initdb: error: directory &quot;/var/lib/postgresql/data&quot; exists but is not empty\nIt contains a lost+found directory, perhaps due to it being a mount point.\nUsing a mount point directly as the data directory is not recommended.\nCreate a subdirectory under the mount point.</code></pre></div><p>  you can add subPath configuration:</p><p>  <strong>statefulset.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># ...</span>\n<span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> data\n  <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /var/lib/postgresql/data\n  <span class=\"token key atrule\">subPath</span><span class=\"token punctuation\">:</span> postgres\n<span class=\"token comment\"># ...</span></code></pre></div><p>  This will create a postgres directory where the data will reside. subPaths also make it possible to use single volume for multiple purposes.</p></exercise><h3 id=\"from-service-to-ingress\" style=\"position:relative;\">From Service to Ingress<a href=\"#from-service-to-ingress\" aria-label=\"from service to ingress permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3><p>Services are quite simple. Let's try using ingress since it offers us additional tools in exchange for complexity.</p><p><em>NodePort</em> type service is required with an Ingress in GKE. Even though it is NodePort, GKE does not expose it outside the cluster. Let's test this by continuing with the previous example.</p><p><strong>service.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> seedimage<span class=\"token punctuation\">-</span>svc\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> NodePort\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> seedimage\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3000</span></code></pre></div><p><strong>ingress.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> seedimage<span class=\"token punctuation\">-</span>ing\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /\n        <span class=\"token key atrule\">pathType</span><span class=\"token punctuation\">:</span> Prefix\n        <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> seedimage<span class=\"token punctuation\">-</span>svc\n            <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">number</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></code></pre></div><p>When you have applied those you can view the port from the list of ingresses:</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ kubectl get ing\n  NAME            CLASS    HOSTS   ADDRESS         PORTS   AGE\n  seedimage-ing   &lt;none&gt;   *       34.120.61.234   80      2m13s</code></pre></div><p>Now the address here will be the way to access the application. This will take a moment to deploy, responses may be 404 and 502 as it becomes available. The Ingress performs health checks by GET requesting / and expects an HTTP 200 response.</p><exercise name='Exercise 3.02: Back to Ingress'><p>  Deploy the \"Log output\" and \"Ping-pong\" applications into GKE and expose it with Ingress.</p><p>  \"Ping-pong\" will have to respond from /pingpong path. This may require you to rewrite parts of the code.</p></exercise><div><quiz id=\"419b91fc-769c-4964-b679-e7790f70799b\"></quiz></div></div>","frontmatter":{"path":"/part-3/1-introduction-to-gke","title":"Introduction to Google Kubernetes Engine"},"fileAbsolutePath":"/Users/matti/dev/kubernetes-hy.github.io/data/part-3/1-introduction-to-gke.md"},"allPages":{"edges":[{"node":{"id":"342f8ea2-aafe-5193-a678-fb17d3725d32","frontmatter":{"path":"/faq","title":"FAQ"}}},{"node":{"id":"fdefbfd6-81fe-562b-98e3-ccae193a91e8","frontmatter":{"path":"/known-problems-solutions","title":"Issues you may face"}}},{"node":{"id":"b1c47f2d-76e9-58d8-9a14-2b6132468171","frontmatter":{"path":"/frontmatter-guide","title":"Frontmatter-guide"}}},{"node":{"id":"9d9ca5cf-d405-50f5-b561-f857d2a77c76","frontmatter":{"path":"/","title":"Homepage"}}},{"node":{"id":"12166a9a-6e11-5213-94d8-08c3f18bce09","frontmatter":{"path":"/sanasto","title":"Sanasto"}}},{"node":{"id":"e3b47b8d-b7b8-54b4-a215-c9eb36925f0f","frontmatter":{"path":"/registration-and-completion","title":"Registration and Completion"}}},{"node":{"id":"a79d5d8c-ad53-500d-8bd4-f94a6bae94ac","frontmatter":{"path":"/unity-assignment","title":"Unity Assignment"}}},{"node":{"id":"4a2c3c05-edf2-53c2-9169-57e05202fcca","frontmatter":{"path":"/part-3/1-introduction-to-gke","title":"Introduction to Google Kubernetes Engine"}}},{"node":{"id":"7e04a54c-201c-5657-a4c3-6b141528e314","frontmatter":{"path":"/part-3/2-deployment-pipeline","title":"Deployment Pipeline"}}},{"node":{"id":"44c243fb-0699-52ee-a2b8-95681b80bfe1","frontmatter":{"path":"/part-3/3-gke-features","title":"GKE features"}}},{"node":{"id":"957e10d7-8115-5f62-8d6a-8046d6a83dab","frontmatter":{"path":"/part-3/4-summary","title":"Summary"}}},{"node":{"id":"24e8849f-09ad-5dc0-ada7-9ee5278ef27b","frontmatter":{"path":"/part-0","title":"Part 0"}}},{"node":{"id":"e873c4f2-48f2-5265-8a29-233223f3a2e1","frontmatter":{"path":"/part-4/3-gitops","title":"GitOps"}}},{"node":{"id":"6d10a184-73f2-50fe-9846-d93c98783482","frontmatter":{"path":"/part-3","title":"Part 3"}}},{"node":{"id":"d6fe4633-2095-505a-9374-d3713aa920fd","frontmatter":{"path":"/part-4/2-messaging-systems","title":"Messaging Systems"}}},{"node":{"id":"ae51dedf-a0ed-56ed-9043-8d4381286dd5","frontmatter":{"path":"/part-4/1-update-strategies-and-prometheus","title":"Update Strategies and Prometheus"}}},{"node":{"id":"e85ff2b4-7f6c-5a7b-9409-b1b5e26c6b02","frontmatter":{"path":"/part-4/4-summary","title":"Summary"}}},{"node":{"id":"2399333a-4e86-5a72-880d-935a3113f024","frontmatter":{"path":"/part-4","title":"Part 4"}}},{"node":{"id":"0e6f20e1-e40e-5550-ac88-a516d2881edb","frontmatter":{"path":"/part-5/3-service-mesh","title":"Service Mesh"}}},{"node":{"id":"943bc3f1-aa37-5a30-8232-b7fe114261c5","frontmatter":{"path":"/part-5/1-kubernetes-internals","title":"Kubernetes Internals"}}},{"node":{"id":"c25696ec-1bd0-521b-8b74-6a6f86514402","frontmatter":{"path":"/part-5/2-custom-resource-definitions","title":"Custom Resource Definitions"}}},{"node":{"id":"da008aad-9b57-5596-b867-815a42284aa3","frontmatter":{"path":"/part-5/4-beyond-kubernetes","title":"Beyond Kubernetes"}}},{"node":{"id":"f2603f2a-7d1c-577c-b6ef-cff715589ff2","frontmatter":{"path":"/part-1/1-first-deploy","title":"First Deploy"}}},{"node":{"id":"13493822-b1dd-5402-a880-ce7945761246","frontmatter":{"path":"/part-5","title":"Part 5"}}},{"node":{"id":"6510eba0-b261-5617-9467-bdd7c41e3e66","frontmatter":{"path":"/part-1/3-introduction-to-networking","title":"Introduction to Networking"}}},{"node":{"id":"2ba0190c-ea90-5e02-9246-5e13c62bd6e2","frontmatter":{"path":"/part-5/5-summary","title":"Summary and end"}}},{"node":{"id":"ae65c6ca-f091-5e34-8e08-1a0c32f5e872","frontmatter":{"path":"/part-1/2-introduction-to-debugging","title":"Introduction to Debugging"}}},{"node":{"id":"77584bf2-b9d2-5000-9c4e-ffae7142b953","frontmatter":{"path":"/part-1/5-summary","title":"Summary"}}},{"node":{"id":"33a50027-b9c0-5adf-ba80-9517be19aa92","frontmatter":{"path":"/part-1/4-introduction-to-storage","title":"Introduction to Storage"}}},{"node":{"id":"b329e1eb-4475-517c-aacc-00490d0d2839","frontmatter":{"path":"/part-1","title":"Part 1"}}},{"node":{"id":"ef8184fe-25fd-55c7-b2b0-89488dbeda0a","frontmatter":{"path":"/part-2/2-organizing-a-cluster","title":"Organizing a cluster"}}},{"node":{"id":"c36d04e4-b166-5cd2-97bf-2d83da8e72fe","frontmatter":{"path":"/part-2/1-networking-between-pods","title":"Networking between pods"}}},{"node":{"id":"db3d8354-0a0e-5f48-8fc5-2df668241733","frontmatter":{"path":"/part-2/3-configuring-applications","title":"Configuring applications"}}},{"node":{"id":"3b8b3351-9969-5ac2-b5c8-e8c709eb3382","frontmatter":{"path":"/part-2/4-statefulsets-and-jobs","title":"StatefulSets and Jobs"}}},{"node":{"id":"38fa2dd0-5645-562f-8e0b-eff8542c3117","frontmatter":{"path":"/part-2/5-monitoring","title":"Monitoring"}}},{"node":{"id":"478f0beb-6ceb-5414-ae92-e25793249bc2","frontmatter":{"path":"/part-2/6-summary","title":"Summary"}}},{"node":{"id":"f52cacfb-80fe-5e11-bf42-3655f4dff267","frontmatter":{"path":"/part-2","title":"Part 2"}}}]}},"pageContext":{}},"staticQueryHashes":["3294351120","994120085"]}