{"componentChunkName":"component---src-templates-course-content-template-js","path":"/part-4/2-messaging-systems","result":{"data":{"page":{"htmlAst":{"type":"element","tagName":"div","properties":{},"children":[{"type":"element","tagName":"text-box","properties":{"variant":"learningObjectives","name":"Learning Objectives"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"After this section you can"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Create a complex microservice architecture with NATS as the messaging system"}]},{"type":"text","value":"\n"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Message Queues are a method for communication between services. They have a wide range of use cases and are helpful when you want to scale applications. A number of HTTP REST API services that want to communicate with each other require that the services know each otherâ€™s addresses. Whereas when using message queues, messages are sent to and received from the message queue, respectively."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The section headline \"Message Queues\" can unfortunately be a little bit misleading. We will be using "},{"type":"element","tagName":"a","properties":{"href":"https://docs.nats.io/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"NATS"}]},{"type":"text","value":", a \"messaging system\", to explore the benefits of messaging. Before we get started we will need to discuss the differences between NATS and a more conventional message queue."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"With NATS we can implement \"at-most-once\" messaging between our services. Conventionally message queues can persist the messages until another service consumes it. For example, in a case where none of the handlers for a message are available. \"NATS Streaming\", or STAN, is the opposite of NATS and would offer us \"at-least-once\" messaging with persistence."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This in mind we can design our first application that uses messages for communication."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We have a data set of 100 000 JSON objects that we need to do some heavy processing on and then save the processed data. Unfortunately processing a single json object takes so long that processing all of the data would require hours of work. To solve this I've split the application into smaller services that we can scale individually."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The application is in 3 parts, for simplification the saving to a database and fetching from external API are omitted:"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Fetcher, which fetches unprocessed data and passes it to NATS."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Mapper, which processes the data from NATS and after processing sends it back to NATS."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Saver, which receives the processed data from NATS and finally (could) save it."}]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 649px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/c4b57de891c9b1b647cbbf1a340cc07a/7762d/app9-plan.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 26.521739130434778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABZElEQVR42j2QO0vDUBTHj6B0cHARcekogqAfwdXBtaBjBgeLQhydHLooIhrrC9zsR1AhYCCB1rShD9q0Q6ClEpq29N3apI+kNNdzhfbCn3vv75z7P+ceyOfzkMlkdobDIRmNRnPRO5XjOKRSqZBOp0Ns257zWd54PCamaf4wDONhWRagXq9DLpfbxP2x3+8HWq0W12w27weDwYllWed4fur1eheNRuMSc4LIT9HgrN1u32KRAOq6WCxeiaK4omkaAM/zUCgUjsLh8Gc6nT5MJpN3iUQiSDvPZrMbkiR9pFKpPUVRmGg0+lAul4EQAsifBUE4iMfjx7Is82i6S73+g6FQaBu/FcFqX91uN4ZBlnJVVVd1XX/HrkXs6NswjJtqtQp+v3+pVCq9IpexW6lWq735fL5lAPCgYI3juH00IJhAJpMJncsLNcRH69Pp9BfNZvOMUI5rwXVddTZL5IbX691CvvgHlOws5DGoZkwAAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/c4b57de891c9b1b647cbbf1a340cc07a/a0b58/app9-plan.webp 230w","/static/c4b57de891c9b1b647cbbf1a340cc07a/bc10c/app9-plan.webp 460w","/static/c4b57de891c9b1b647cbbf1a340cc07a/df8c5/app9-plan.webp 649w"],"sizes":["(max-width:","649px)","100vw,","649px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/c4b57de891c9b1b647cbbf1a340cc07a/81c8e/app9-plan.png 230w","/static/c4b57de891c9b1b647cbbf1a340cc07a/08a84/app9-plan.png 460w","/static/c4b57de891c9b1b647cbbf1a340cc07a/7762d/app9-plan.png 649w"],"sizes":["(max-width:","649px)","100vw,","649px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/c4b57de891c9b1b647cbbf1a340cc07a/7762d/app9-plan.png","alt":"app9 plan","title":"app9 plan","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"deployment.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" apps/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Deployment\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" mapper"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dep\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"replicas"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"10"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"selector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"matchLabels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" mapper\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"template"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"labels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" mapper\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"containers"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" mapper\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"app9"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"mapper"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"0bcd6794804c367684a9a79bb142bb4455096974\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"---"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" apps/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Deployment\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" fetcher"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dep\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"replicas"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"selector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"matchLabels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" fetcher\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"template"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"labels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" fetcher\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"containers"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" fetcher\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"app9"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"fetcher"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"0bcd6794804c367684a9a79bb142bb4455096974\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"---"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" apps/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Deployment\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" saver"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dep\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"replicas"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"selector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"matchLabels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" saver\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"template"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"labels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" saver\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"containers"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" saver\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"app9"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"saver"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"0bcd6794804c367684a9a79bb142bb4455096974"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In this case the application is designed so that Fetcher can not be scaled. Fetcher splits the data into chunks of 100 objects and keeps a record of which chunks have not been processed. Fetcher will wait for a Mapper to send a message confirming that it's listening before sending data forward. Note how the available Mapper will be the one to receive the message so the fastest Mapper could process a large number of chunks while some of them might crash or be extremely slow. Saver will send a confirmation to Fetcher when a chunk has been saved and it will mark it as processed. So even if any part of the application crashes all of the data will be processed and saved."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We're going to use Helm to install NATS into our cluster."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ helm repo add nats https://nats-io.github.io/k8s/helm/charts/\n  ...\n$ helm repo update\n...\n$ helm install my-nats nats/nats\n  NAME: my-nats\n  LAST DEPLOYED: Thu Jul  2 15:04:56 2020\n  NAMESPACE: default\n  STATUS: deployed\n  REVISION: 1\n  TEST SUITE: None\n  NOTES:\n  You can find more information about running NATS on Kubernetes\n  in the NATS documentation website:\n\n    https://docs.nats.io/nats-on-kubernetes/nats-kubernetes\n\n  NATS Box has been deployed into your cluster, you can\n  now use the NATS tools within the container as follows:\n\n    kubectl exec -n default -it my-nats-box -- /bin/sh -l\n\n    nats-box:~# nats-sub test &\n    nats-box:~# nats-pub test hi\n    nats-box:~# nc my-nats 4222\n\n  Thanks for using NATS!"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This added NATS into the cluster. At this state however, the applications don't know where the NATS is so we'll add that to each of the deployments"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"deployment.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"text","value":"      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"..."}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"containers"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" mapper\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"app9"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"mapper"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"0bcd6794804c367684a9a79bb142bb4455096974\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"env"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" NATS_URL\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"value"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" nats"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"//my"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"nats"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"4222"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"..."}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"app9"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"fetcher"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"0bcd6794804c367684a9a79bb142bb4455096974\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"env"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" NATS_URL\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"value"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" nats"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"//my"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"nats"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"4222"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"..."}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"app9"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"saver"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"0bcd6794804c367684a9a79bb142bb4455096974\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"env"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" NATS_URL\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"value"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" nats"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"//my"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"nats"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"4222"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"After applying the modified deployments we can confirm that everything is working here by reading the logs of the fetcher - "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"kubectl logs fetcher-dep-7d799bb6bf-zz8hr -f"}]},{"type":"text","value":". We'll want to monitor the state of NATS as well. Fortunately it already has a Prometheus Exporter included in port 7777. We can access from browser with "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"kubectl port-forward my-nats-0 7777:7777"}]},{"type":"text","value":" in "},{"type":"element","tagName":"a","properties":{"href":"http://127.0.0.1:7777/metrics","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"http://127.0.0.1:7777/metrics"}]},{"type":"text","value":" to confirm that it works. Connecting Prometheus to the exporter will require a new resource ServiceMonitor another new CRD (Custom Resource Definition)."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"servicemonitor.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" monitoring.coreos.com/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" ServiceMonitor\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" monitoring"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"nats\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"namespace"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" prometheus\n  "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# We need a label so that Prometheus knows to listen to this"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"selector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"matchLabels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# We also need a label which we want to listen"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"endpoints"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"interval"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 10s\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"path"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" /metrics\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"port"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# We need to define the port which should be listened"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"namespaceSelector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"matchNames"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" default"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Let's fill in the missing data with a bit of detective work. Let's use the label the already existing ServiceMonitors use for now. We can check it with the following."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ kubectl -n prometheus get prometheus\n  NAME                                    VERSION   REPLICAS   AGE\n  kube-prometheus-stack-1602-prometheus   v2.18.2   1          39h\n\n$ kubectl describe prometheus -n prometheus kube-prometheus-stack-1602-prometheus\n...\n Service Monitor Selector:\n    Match Labels:\n      Release:  kube-prometheus-stack-1602180058\n..."}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"So the label needs to be \"release: kube-prometheus-stack-1602180058\" unless we'd like to define a new Prometheus resource. The port has been set by my-nats so we can find out the name with"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ kubectl describe svc my-nats\n  Port:              metrics  7777/TCP\n  TargetPort:        7777/TCP\n  Endpoints:         10.42.1.31:7777"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"And the label we want to listen can be found with "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"kubectl describe"}]},{"type":"text","value":". I found the label "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"app.kubernetes.io/name=nats"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"So finally we can fill it with"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: monitoring-nats\n  namespace: prometheus\n  labels:\n    release: kube-prometheus-stack-1602180058\nspec:\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: nats\n  endpoints:\n    - interval: 10s\n      path: /metrics\n      port: metrics\n  namespaceSelector:\n    matchNames:\n      - default"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"And now Prometheus has access to the new data. Let's check Prometheus:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ kubectl -n prometheus port-forward prometheus-kube-prometheus-stack-1602-prometheus-0 9090\nForwarding from 127.0.0.1:9090 -> 9090\nForwarding from [::1]:9090 -> 9090"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"And then Prometheus API should return a result:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ curl 'http://localhost:9090/api/v1/query?query=nats_varz_cpu'\n  {\"status\":\"success\",\"data\":{\"resultType\":\"vector\",\"result\":[{\"metric\":{\"__name__\":\"nats_varz_cpu\",\"endpoint\":\"metrics\",\"instance\":\"10.42.1.31:7777\",\"job\":\"my-nats\",\"namespace\":\"default\",\"pod\":\"my-nats-0\",\"server_id\":\"NDYRLXL5ULWCAH7F3HRSIGHEENDQJGCJRLREAZY46FBPREIED4F24YQS\",\"service\":\"my-nats\"},\"value\":[1593781676.273,\"2\"]}]}}"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"If the result here is empty then something is wrong, the result may be a success even if the query doesn't make sense."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now we just need to add a Grafana dashboard for the data. Let's import a dashboard from "},{"type":"element","tagName":"a","properties":{"href":"https://raw.githubusercontent.com/nats-io/prometheus-nats-exporter/5084a32850823b59069f21f3a7dde7e488fef1c6/walkthrough/grafana-nats-dash.json","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"here"}]},{"type":"text","value":" instead of configuring our own. Note that the dashboard resources are defined as \"gnatsd"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"XXXX\" whereas our resources as seen from the Prometheus Exporter "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"kubectl port-forward my-nats-0 7777:7777"}]},{"type":"text","value":" in "},{"type":"element","tagName":"a","properties":{"href":"http://127.0.0.1:7777/metrics","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"http://127.0.0.1:7777/metrics"}]},{"type":"text","value":" are \"nats"}]},{"type":"text","value":"XXXX\" - so we need to search and replace all \"gnatsd"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"XXXX\" with \"nats"}]},{"type":"text","value":"XXXX\" in the dashboard for the data to pass correctly from prometheus."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ kubectl -n prometheus port-forward kube-prometheus-stack-1602180058-grafana-59cd48d794-4459m 3000"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Here we can paste the JSON to \"import via panel json\" and then choose Prometheus as the source on the following page."}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/1c5c58d0cebf3b168cefecb38ee560e0/12bff/grafana-import.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 64.78260869565217%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABmUlEQVR42pVSyU7jQBDtI04gaW9tu73FS5zECU5ALDOckLghNNJ8Cmcuc5nvflS1SDAW6+GpXFWvX7+qtujKEElWYFY2yIv5p2BOWS8xX6xRzVfIZrWp7yNDqDBCnM4M+SvUzQoXV79x/evGxPlig2Z1igWBL2COiNOSlGuTsNMozqCTHDrugXKux1mNtOqgizV0ViEhI/EL9mcECy3XW7SbHYIoge0quH44QATHthE2N9j+/Y/uzz+o8hJSStN3vODAFexuvemwOT2DpyLT5DgE12OaoCXeii5vu3NUtAI/0Kbvemwk4JFzFEWFjIRNg27px2GND3m9XNouJlMbzd0j8t0DRJpXmDr+YdShWN8h75FfeVYtjLuI9rbnqnQJXxcQoU7fjPmRKOd+qBERn8/oF7GpdMmlRy4lHNeHYDGb5n8d6eORpePhyBoRxiZao2OMxicG/M19weT3BIfuOPJaxseTd8GiPxekA5ZlHVz18TOHHLkXJJAqx0Q6tLMeTG7TW6jvCXpKmx87bm/R3j8ZYU+Fpj7kPgM//FH4dyZc2AAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/1c5c58d0cebf3b168cefecb38ee560e0/a0b58/grafana-import.webp 230w","/static/1c5c58d0cebf3b168cefecb38ee560e0/bc10c/grafana-import.webp 460w","/static/1c5c58d0cebf3b168cefecb38ee560e0/966d8/grafana-import.webp 920w","/static/1c5c58d0cebf3b168cefecb38ee560e0/6ed01/grafana-import.webp 1032w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/1c5c58d0cebf3b168cefecb38ee560e0/81c8e/grafana-import.png 230w","/static/1c5c58d0cebf3b168cefecb38ee560e0/08a84/grafana-import.png 460w","/static/1c5c58d0cebf3b168cefecb38ee560e0/c0255/grafana-import.png 920w","/static/1c5c58d0cebf3b168cefecb38ee560e0/12bff/grafana-import.png 1032w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/1c5c58d0cebf3b168cefecb38ee560e0/c0255/grafana-import.png","alt":"grafana import","title":"grafana import","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"And now we have a simple dashboard with data:"}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/9805594f4c1b4bdea7a35f4534b4f1e1/9e7e4/grafana-nats.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 47.39130434782609%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABaklEQVR42k1SWXbEIAzLAWbJCsSsSWbr9P7nUy0yafuhlyALI2EaEYGdAy7XHudLq+hwbQeczm0FudOl/dT+1tR3/VS1xDAaTMahcZIwTA6jmSsmK5h9gvUBc4wqEuXmyrF26CRleIX1HlY8XAi4dgMauiMkZN2UEfICnzPiWip8WRDWDbPWfSxVx2++b4p1x2PD+n6hG8a9oY9ZhQlOIqzzat+i7cbqiOh1TY7aoM2sCzDKU9P1Bm6OGCep19CwCeMwNu37Rdch/sZnFCnaKK97XMZPamJJMHo4OUaWomaCoOGmVDbEsmJ93rG97pDIWAvSsmL7emB53JTTK9CmWePf3k8UjUwjPpX6f/9+IZSMhs54LyMdaiQOgdPjmmDUfTDyj3PoB6tXYWpTuiTXDWZvWGE+Dd0+VaIKtUaOtdG4CiuhRq9x5/2feh6uDW09hS4POD4bfU7H9A9Q5/QlWL33Y9oH+AomHdYPdEzoNiBB69gAAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/9805594f4c1b4bdea7a35f4534b4f1e1/a0b58/grafana-nats.webp 230w","/static/9805594f4c1b4bdea7a35f4534b4f1e1/bc10c/grafana-nats.webp 460w","/static/9805594f4c1b4bdea7a35f4534b4f1e1/966d8/grafana-nats.webp 920w","/static/9805594f4c1b4bdea7a35f4534b4f1e1/445df/grafana-nats.webp 1380w","/static/9805594f4c1b4bdea7a35f4534b4f1e1/78de1/grafana-nats.webp 1840w","/static/9805594f4c1b4bdea7a35f4534b4f1e1/27d84/grafana-nats.webp 2056w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/9805594f4c1b4bdea7a35f4534b4f1e1/81c8e/grafana-nats.png 230w","/static/9805594f4c1b4bdea7a35f4534b4f1e1/08a84/grafana-nats.png 460w","/static/9805594f4c1b4bdea7a35f4534b4f1e1/c0255/grafana-nats.png 920w","/static/9805594f4c1b4bdea7a35f4534b4f1e1/b1001/grafana-nats.png 1380w","/static/9805594f4c1b4bdea7a35f4534b4f1e1/161ec/grafana-nats.png 1840w","/static/9805594f4c1b4bdea7a35f4534b4f1e1/9e7e4/grafana-nats.png 2056w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/9805594f4c1b4bdea7a35f4534b4f1e1/c0255/grafana-nats.png","alt":"grafana nats","title":"grafana nats","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This is now the final configuration:"}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 441px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/709982b7337c907e82909551fcb98e51/efc6e/app9-nats-prometheus-grafana.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 90.8695652173913%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAACuklEQVR42oVUS09aURA+umhX7X/wZ/g/mm7bXSVtV23SRldI04SoaZcaFhqoCe9S4IJEg8RICZEQeQQwPkBRHspb3rfk9Jub3BtjQ+9JJucxM9+ZM9/MYezRODw8ZJxzScrlsrff7/O7u7tRrVYb0ZrOZH0sFmOqIx6PK4DdbjeEmV9eXvKbmxta8vv7+5Csz2Qy6oDBYFABLBQKi81mUwCIo9Vq/YR48/n8kqwPh8PqgMfHxzLgDJ5KR0+cTucnh8PxGeunlUqF4emzZHNycqIOuLe3p0R4fn7+pt1ubyCqH4jWhGg36EzWU75Vx9HRkQKIpx50Oh1eLBalPPZ6PY79gaxPpVLqgNFoVAGk/I3HY47c/Wk0GpPhcMgxC7I+kUioA+7v7z8kxQUmOZiv4KIKcsavrq5csj4SifwLYDQamc1mYxaLhVmtVub3+9n6+jo5zOJJc6FQaN7tdr92uVyvwOp8Op2eIx3Z+Hw+yYd8QRozGAxMieaRzDzcBwKBtxDN/2xkmQbIcrncAiL0gnXT7u7uNupzm9aI0IOnL0zzo/aiwhVQHj6IABZ9IOMX5jrOebVapXZTBDbULTXYuMmWfECabzAYCCgpgVEpqI3b21ter9dV7dAIEpOruEUPNjfQr9/guAIAPTpiDfMWymQTNhawa0ZUm9BvIeo1iB66FdTod/JF3+uz2ezq1BxqtdpnaLn3Ho9HYzKZPkI+gEmN2Wx+p9Ppnk/N4fX1tR3PtiI6PyKw49YAWu3FZDJhmJcpt4jWS98WckV5WibdxcXFS9j7EbEDGH4UvfX09NTORFGU3l8qlTjCltYA+UK3jUaj37Snrwv/oaSDI50xgH+lPf2RRBwNnHEGVBFg4tnZmYh+7VPfojQWwRr9JjvELGyG0A9pjXLaAbvUx0uIjHp8QL4gREwmk+JfO/KnjEy5u4gAAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/709982b7337c907e82909551fcb98e51/a0b58/app9-nats-prometheus-grafana.webp 230w","/static/709982b7337c907e82909551fcb98e51/24c94/app9-nats-prometheus-grafana.webp 441w"],"sizes":["(max-width:","441px)","100vw,","441px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/709982b7337c907e82909551fcb98e51/81c8e/app9-nats-prometheus-grafana.png 230w","/static/709982b7337c907e82909551fcb98e51/efc6e/app9-nats-prometheus-grafana.png 441w"],"sizes":["(max-width:","441px)","100vw,","441px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/709982b7337c907e82909551fcb98e51/efc6e/app9-nats-prometheus-grafana.png","alt":"app9 nats prometheus grafana","title":"app9 nats prometheus grafana","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"exercise","properties":{"name":"Exercise 4.06: Project v2.0"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  Create a new separate service for sending status messages of the todos to a popular chat application. Let's call the new service \"broadcaster\"."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  Requirements:"}]},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"The backend saving / updating todos should send a message to NATS"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"The broadcaster should subscribe to NATS messages"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"The broadcaster should send the message forward to an external service in a format they support"}]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  Choose either:"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Telegram"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Slack"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Discord"}]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  or if you don't want to use them use \"Generic\" where an URL is set as an Environment variable and the payload is e.g."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"json"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-json"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-json"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"\"user\""}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"bot\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"\"message\""}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"A todo was created\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  The broadcaster should be able to be scaled without sending the message multiple times. Test that it can run with 6 replicas without issues. The messages only have to be sent to the external service if all of the services are working correctly. So a randomly missing message is not an issue but a duplicate is."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  Example of a working broadcaster:\n"},{"type":"element","tagName":"img","properties":{"src":"/373b4b99e844fb5340312e7460d81ccf/ex406-solution.gif"},"children":[]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  You should not write the API key in plain text."}]}]},{"type":"element","tagName":"div","properties":{},"children":[{"type":"element","tagName":"quiz","properties":{"id":"de114052-aefa-47ca-880c-87f2350a63b6"},"children":[]}]}]},"html":"<div><text-box variant='learningObjectives' name='Learning Objectives'><p>After this section you can</p><ul>\n<li>Create a complex microservice architecture with NATS as the messaging system</li>\n</ul></text-box><p>Message Queues are a method for communication between services. They have a wide range of use cases and are helpful when you want to scale applications. A number of HTTP REST API services that want to communicate with each other require that the services know each otherâ€™s addresses. Whereas when using message queues, messages are sent to and received from the message queue, respectively.</p><p>The section headline \"Message Queues\" can unfortunately be a little bit misleading. We will be using <a href=\"https://docs.nats.io/\" target=\"_blank\" rel=\"noopener noreferrer\">NATS</a>, a \"messaging system\", to explore the benefits of messaging. Before we get started we will need to discuss the differences between NATS and a more conventional message queue.</p><p>With NATS we can implement \"at-most-once\" messaging between our services. Conventionally message queues can persist the messages until another service consumes it. For example, in a case where none of the handlers for a message are available. \"NATS Streaming\", or STAN, is the opposite of NATS and would offer us \"at-least-once\" messaging with persistence.</p><p>This in mind we can design our first application that uses messages for communication.</p><p>We have a data set of 100 000 JSON objects that we need to do some heavy processing on and then save the processed data. Unfortunately processing a single json object takes so long that processing all of the data would require hours of work. To solve this I've split the application into smaller services that we can scale individually.</p><p>The application is in 3 parts, for simplification the saving to a database and fetching from external API are omitted:</p><ul>\n<li>Fetcher, which fetches unprocessed data and passes it to NATS.</li>\n<li>Mapper, which processes the data from NATS and after processing sends it back to NATS.</li>\n<li>Saver, which receives the processed data from NATS and finally (could) save it.</li>\n</ul><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 649px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/c4b57de891c9b1b647cbbf1a340cc07a/7762d/app9-plan.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 26.521739130434778%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABZElEQVR42j2QO0vDUBTHj6B0cHARcekogqAfwdXBtaBjBgeLQhydHLooIhrrC9zsR1AhYCCB1rShD9q0Q6ClEpq29N3apI+kNNdzhfbCn3vv75z7P+ceyOfzkMlkdobDIRmNRnPRO5XjOKRSqZBOp0Ns257zWd54PCamaf4wDONhWRagXq9DLpfbxP2x3+8HWq0W12w27weDwYllWed4fur1eheNRuMSc4LIT9HgrN1u32KRAOq6WCxeiaK4omkaAM/zUCgUjsLh8Gc6nT5MJpN3iUQiSDvPZrMbkiR9pFKpPUVRmGg0+lAul4EQAsifBUE4iMfjx7Is82i6S73+g6FQaBu/FcFqX91uN4ZBlnJVVVd1XX/HrkXs6NswjJtqtQp+v3+pVCq9IpexW6lWq735fL5lAPCgYI3juH00IJhAJpMJncsLNcRH69Pp9BfNZvOMUI5rwXVddTZL5IbX691CvvgHlOws5DGoZkwAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/c4b57de891c9b1b647cbbf1a340cc07a/a0b58/app9-plan.webp 230w,\n/static/c4b57de891c9b1b647cbbf1a340cc07a/bc10c/app9-plan.webp 460w,\n/static/c4b57de891c9b1b647cbbf1a340cc07a/df8c5/app9-plan.webp 649w\" sizes=\"(max-width: 649px) 100vw, 649px\" type=\"image/webp\">\n        <source srcset=\"/static/c4b57de891c9b1b647cbbf1a340cc07a/81c8e/app9-plan.png 230w,\n/static/c4b57de891c9b1b647cbbf1a340cc07a/08a84/app9-plan.png 460w,\n/static/c4b57de891c9b1b647cbbf1a340cc07a/7762d/app9-plan.png 649w\" sizes=\"(max-width: 649px) 100vw, 649px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/c4b57de891c9b1b647cbbf1a340cc07a/7762d/app9-plan.png\" alt=\"app9 plan\" title=\"app9 plan\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><p><strong>deployment.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mapper<span class=\"token punctuation\">-</span>dep\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> mapper\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> mapper\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mapper\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jakousa/dwk<span class=\"token punctuation\">-</span>app9<span class=\"token punctuation\">-</span>mapper<span class=\"token punctuation\">:</span>0bcd6794804c367684a9a79bb142bb4455096974\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> fetcher<span class=\"token punctuation\">-</span>dep\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> fetcher\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> fetcher\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> fetcher\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jakousa/dwk<span class=\"token punctuation\">-</span>app9<span class=\"token punctuation\">-</span>fetcher<span class=\"token punctuation\">:</span>0bcd6794804c367684a9a79bb142bb4455096974\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> saver<span class=\"token punctuation\">-</span>dep\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> saver\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> saver\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> saver\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jakousa/dwk<span class=\"token punctuation\">-</span>app9<span class=\"token punctuation\">-</span>saver<span class=\"token punctuation\">:</span>0bcd6794804c367684a9a79bb142bb4455096974</code></pre></div><p>In this case the application is designed so that Fetcher can not be scaled. Fetcher splits the data into chunks of 100 objects and keeps a record of which chunks have not been processed. Fetcher will wait for a Mapper to send a message confirming that it's listening before sending data forward. Note how the available Mapper will be the one to receive the message so the fastest Mapper could process a large number of chunks while some of them might crash or be extremely slow. Saver will send a confirmation to Fetcher when a chunk has been saved and it will mark it as processed. So even if any part of the application crashes all of the data will be processed and saved.</p><p>We're going to use Helm to install NATS into our cluster.</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ helm repo add nats https://nats-io.github.io/k8s/helm/charts/\n  ...\n$ helm repo update\n...\n$ helm install my-nats nats/nats\n  NAME: my-nats\n  LAST DEPLOYED: Thu Jul  2 15:04:56 2020\n  NAMESPACE: default\n  STATUS: deployed\n  REVISION: 1\n  TEST SUITE: None\n  NOTES:\n  You can find more information about running NATS on Kubernetes\n  in the NATS documentation website:\n\n    https://docs.nats.io/nats-on-kubernetes/nats-kubernetes\n\n  NATS Box has been deployed into your cluster, you can\n  now use the NATS tools within the container as follows:\n\n    kubectl exec -n default -it my-nats-box -- /bin/sh -l\n\n    nats-box:~# nats-sub test &amp;\n    nats-box:~# nats-pub test hi\n    nats-box:~# nc my-nats 4222\n\n  Thanks for using NATS!</code></pre></div><p>This added NATS into the cluster. At this state however, the applications don't know where the NATS is so we'll add that to each of the deployments</p><p><strong>deployment.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">      <span class=\"token punctuation\">...</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mapper\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jakousa/dwk<span class=\"token punctuation\">-</span>app9<span class=\"token punctuation\">-</span>mapper<span class=\"token punctuation\">:</span>0bcd6794804c367684a9a79bb142bb4455096974\n          <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> NATS_URL\n              <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> nats<span class=\"token punctuation\">:</span>//my<span class=\"token punctuation\">-</span>nats<span class=\"token punctuation\">:</span><span class=\"token number\">4222</span>\n      <span class=\"token punctuation\">...</span>\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jakousa/dwk<span class=\"token punctuation\">-</span>app9<span class=\"token punctuation\">-</span>fetcher<span class=\"token punctuation\">:</span>0bcd6794804c367684a9a79bb142bb4455096974\n          <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> NATS_URL\n              <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> nats<span class=\"token punctuation\">:</span>//my<span class=\"token punctuation\">-</span>nats<span class=\"token punctuation\">:</span><span class=\"token number\">4222</span>\n      <span class=\"token punctuation\">...</span>\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jakousa/dwk<span class=\"token punctuation\">-</span>app9<span class=\"token punctuation\">-</span>saver<span class=\"token punctuation\">:</span>0bcd6794804c367684a9a79bb142bb4455096974\n          <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> NATS_URL\n              <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> nats<span class=\"token punctuation\">:</span>//my<span class=\"token punctuation\">-</span>nats<span class=\"token punctuation\">:</span><span class=\"token number\">4222</span></code></pre></div><p>After applying the modified deployments we can confirm that everything is working here by reading the logs of the fetcher - <code class=\"language-text\">kubectl logs fetcher-dep-7d799bb6bf-zz8hr -f</code>. We'll want to monitor the state of NATS as well. Fortunately it already has a Prometheus Exporter included in port 7777. We can access from browser with <code class=\"language-text\">kubectl port-forward my-nats-0 7777:7777</code> in <a href=\"http://127.0.0.1:7777/metrics\" target=\"_blank\" rel=\"noopener noreferrer\">http://127.0.0.1:7777/metrics</a> to confirm that it works. Connecting Prometheus to the exporter will require a new resource ServiceMonitor another new CRD (Custom Resource Definition).</p><p><strong>servicemonitor.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> monitoring.coreos.com/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ServiceMonitor\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> monitoring<span class=\"token punctuation\">-</span>nats\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> prometheus\n  <span class=\"token comment\"># We need a label so that Prometheus knows to listen to this</span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># We also need a label which we want to listen</span>\n  <span class=\"token key atrule\">endpoints</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 10s\n      <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /metrics\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># We need to define the port which should be listened</span>\n  <span class=\"token key atrule\">namespaceSelector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchNames</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> default</code></pre></div><p>Let's fill in the missing data with a bit of detective work. Let's use the label the already existing ServiceMonitors use for now. We can check it with the following.</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ kubectl -n prometheus get prometheus\n  NAME                                    VERSION   REPLICAS   AGE\n  kube-prometheus-stack-1602-prometheus   v2.18.2   1          39h\n\n$ kubectl describe prometheus -n prometheus kube-prometheus-stack-1602-prometheus\n...\n Service Monitor Selector:\n    Match Labels:\n      Release:  kube-prometheus-stack-1602180058\n...</code></pre></div><p>So the label needs to be \"release: kube-prometheus-stack-1602180058\" unless we'd like to define a new Prometheus resource. The port has been set by my-nats so we can find out the name with</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ kubectl describe svc my-nats\n  Port:              metrics  7777/TCP\n  TargetPort:        7777/TCP\n  Endpoints:         10.42.1.31:7777</code></pre></div><p>And the label we want to listen can be found with <code class=\"language-text\">kubectl describe</code>. I found the label <code class=\"language-text\">app.kubernetes.io/name=nats</code></p><p>So finally we can fill it with</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: monitoring-nats\n  namespace: prometheus\n  labels:\n    release: kube-prometheus-stack-1602180058\nspec:\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: nats\n  endpoints:\n    - interval: 10s\n      path: /metrics\n      port: metrics\n  namespaceSelector:\n    matchNames:\n      - default</code></pre></div><p>And now Prometheus has access to the new data. Let's check Prometheus:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ kubectl -n prometheus port-forward prometheus-kube-prometheus-stack-1602-prometheus-0 9090\nForwarding from 127.0.0.1:9090 -&gt; 9090\nForwarding from [::1]:9090 -&gt; 9090</code></pre></div><p>And then Prometheus API should return a result:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ curl &#39;http://localhost:9090/api/v1/query?query=nats_varz_cpu&#39;\n  {&quot;status&quot;:&quot;success&quot;,&quot;data&quot;:{&quot;resultType&quot;:&quot;vector&quot;,&quot;result&quot;:[{&quot;metric&quot;:{&quot;__name__&quot;:&quot;nats_varz_cpu&quot;,&quot;endpoint&quot;:&quot;metrics&quot;,&quot;instance&quot;:&quot;10.42.1.31:7777&quot;,&quot;job&quot;:&quot;my-nats&quot;,&quot;namespace&quot;:&quot;default&quot;,&quot;pod&quot;:&quot;my-nats-0&quot;,&quot;server_id&quot;:&quot;NDYRLXL5ULWCAH7F3HRSIGHEENDQJGCJRLREAZY46FBPREIED4F24YQS&quot;,&quot;service&quot;:&quot;my-nats&quot;},&quot;value&quot;:[1593781676.273,&quot;2&quot;]}]}}</code></pre></div><p>If the result here is empty then something is wrong, the result may be a success even if the query doesn't make sense.</p><p>Now we just need to add a Grafana dashboard for the data. Let's import a dashboard from <a href=\"https://raw.githubusercontent.com/nats-io/prometheus-nats-exporter/5084a32850823b59069f21f3a7dde7e488fef1c6/walkthrough/grafana-nats-dash.json\" target=\"_blank\" rel=\"noopener noreferrer\">here</a> instead of configuring our own. Note that the dashboard resources are defined as \"gnatsd<em>XXXX\" whereas our resources as seen from the Prometheus Exporter <code class=\"language-text\">kubectl port-forward my-nats-0 7777:7777</code> in <a href=\"http://127.0.0.1:7777/metrics\" target=\"_blank\" rel=\"noopener noreferrer\">http://127.0.0.1:7777/metrics</a> are \"nats</em>XXXX\" - so we need to search and replace all \"gnatsd<em>XXXX\" with \"nats</em>XXXX\" in the dashboard for the data to pass correctly from prometheus.</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ kubectl -n prometheus port-forward kube-prometheus-stack-1602180058-grafana-59cd48d794-4459m 3000</code></pre></div><p>Here we can paste the JSON to \"import via panel json\" and then choose Prometheus as the source on the following page.</p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/1c5c58d0cebf3b168cefecb38ee560e0/12bff/grafana-import.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 64.78260869565217%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABmUlEQVR42pVSyU7jQBDtI04gaW9tu73FS5zECU5ALDOckLghNNJ8Cmcuc5nvflS1SDAW6+GpXFWvX7+qtujKEElWYFY2yIv5p2BOWS8xX6xRzVfIZrWp7yNDqDBCnM4M+SvUzQoXV79x/evGxPlig2Z1igWBL2COiNOSlGuTsNMozqCTHDrugXKux1mNtOqgizV0ViEhI/EL9mcECy3XW7SbHYIoge0quH44QATHthE2N9j+/Y/uzz+o8hJSStN3vODAFexuvemwOT2DpyLT5DgE12OaoCXeii5vu3NUtAI/0Kbvemwk4JFzFEWFjIRNg27px2GND3m9XNouJlMbzd0j8t0DRJpXmDr+YdShWN8h75FfeVYtjLuI9rbnqnQJXxcQoU7fjPmRKOd+qBERn8/oF7GpdMmlRy4lHNeHYDGb5n8d6eORpePhyBoRxiZao2OMxicG/M19weT3BIfuOPJaxseTd8GiPxekA5ZlHVz18TOHHLkXJJAqx0Q6tLMeTG7TW6jvCXpKmx87bm/R3j8ZYU+Fpj7kPgM//FH4dyZc2AAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/1c5c58d0cebf3b168cefecb38ee560e0/a0b58/grafana-import.webp 230w,\n/static/1c5c58d0cebf3b168cefecb38ee560e0/bc10c/grafana-import.webp 460w,\n/static/1c5c58d0cebf3b168cefecb38ee560e0/966d8/grafana-import.webp 920w,\n/static/1c5c58d0cebf3b168cefecb38ee560e0/6ed01/grafana-import.webp 1032w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/webp\">\n        <source srcset=\"/static/1c5c58d0cebf3b168cefecb38ee560e0/81c8e/grafana-import.png 230w,\n/static/1c5c58d0cebf3b168cefecb38ee560e0/08a84/grafana-import.png 460w,\n/static/1c5c58d0cebf3b168cefecb38ee560e0/c0255/grafana-import.png 920w,\n/static/1c5c58d0cebf3b168cefecb38ee560e0/12bff/grafana-import.png 1032w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/1c5c58d0cebf3b168cefecb38ee560e0/c0255/grafana-import.png\" alt=\"grafana import\" title=\"grafana import\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><p>And now we have a simple dashboard with data:</p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/9805594f4c1b4bdea7a35f4534b4f1e1/9e7e4/grafana-nats.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 47.39130434782609%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABaklEQVR42k1SWXbEIAzLAWbJCsSsSWbr9P7nUy0yafuhlyALI2EaEYGdAy7XHudLq+hwbQeczm0FudOl/dT+1tR3/VS1xDAaTMahcZIwTA6jmSsmK5h9gvUBc4wqEuXmyrF26CRleIX1HlY8XAi4dgMauiMkZN2UEfICnzPiWip8WRDWDbPWfSxVx2++b4p1x2PD+n6hG8a9oY9ZhQlOIqzzat+i7cbqiOh1TY7aoM2sCzDKU9P1Bm6OGCep19CwCeMwNu37Rdch/sZnFCnaKK97XMZPamJJMHo4OUaWomaCoOGmVDbEsmJ93rG97pDIWAvSsmL7emB53JTTK9CmWePf3k8UjUwjPpX6f/9+IZSMhs54LyMdaiQOgdPjmmDUfTDyj3PoB6tXYWpTuiTXDWZvWGE+Dd0+VaIKtUaOtdG4CiuhRq9x5/2feh6uDW09hS4POD4bfU7H9A9Q5/QlWL33Y9oH+AomHdYPdEzoNiBB69gAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/9805594f4c1b4bdea7a35f4534b4f1e1/a0b58/grafana-nats.webp 230w,\n/static/9805594f4c1b4bdea7a35f4534b4f1e1/bc10c/grafana-nats.webp 460w,\n/static/9805594f4c1b4bdea7a35f4534b4f1e1/966d8/grafana-nats.webp 920w,\n/static/9805594f4c1b4bdea7a35f4534b4f1e1/445df/grafana-nats.webp 1380w,\n/static/9805594f4c1b4bdea7a35f4534b4f1e1/78de1/grafana-nats.webp 1840w,\n/static/9805594f4c1b4bdea7a35f4534b4f1e1/27d84/grafana-nats.webp 2056w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/webp\">\n        <source srcset=\"/static/9805594f4c1b4bdea7a35f4534b4f1e1/81c8e/grafana-nats.png 230w,\n/static/9805594f4c1b4bdea7a35f4534b4f1e1/08a84/grafana-nats.png 460w,\n/static/9805594f4c1b4bdea7a35f4534b4f1e1/c0255/grafana-nats.png 920w,\n/static/9805594f4c1b4bdea7a35f4534b4f1e1/b1001/grafana-nats.png 1380w,\n/static/9805594f4c1b4bdea7a35f4534b4f1e1/161ec/grafana-nats.png 1840w,\n/static/9805594f4c1b4bdea7a35f4534b4f1e1/9e7e4/grafana-nats.png 2056w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/9805594f4c1b4bdea7a35f4534b4f1e1/c0255/grafana-nats.png\" alt=\"grafana nats\" title=\"grafana nats\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><p>This is now the final configuration:</p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 441px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/709982b7337c907e82909551fcb98e51/efc6e/app9-nats-prometheus-grafana.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 90.8695652173913%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAACuklEQVR42oVUS09aURA+umhX7X/wZ/g/mm7bXSVtV23SRldI04SoaZcaFhqoCe9S4IJEg8RICZEQeQQwPkBRHspb3rfk9Jub3BtjQ+9JJucxM9+ZM9/MYezRODw8ZJxzScrlsrff7/O7u7tRrVYb0ZrOZH0sFmOqIx6PK4DdbjeEmV9eXvKbmxta8vv7+5Csz2Qy6oDBYFABLBQKi81mUwCIo9Vq/YR48/n8kqwPh8PqgMfHxzLgDJ5KR0+cTucnh8PxGeunlUqF4emzZHNycqIOuLe3p0R4fn7+pt1ubyCqH4jWhGg36EzWU75Vx9HRkQKIpx50Oh1eLBalPPZ6PY79gaxPpVLqgNFoVAGk/I3HY47c/Wk0GpPhcMgxC7I+kUioA+7v7z8kxQUmOZiv4KIKcsavrq5csj4SifwLYDQamc1mYxaLhVmtVub3+9n6+jo5zOJJc6FQaN7tdr92uVyvwOp8Op2eIx3Z+Hw+yYd8QRozGAxMieaRzDzcBwKBtxDN/2xkmQbIcrncAiL0gnXT7u7uNupzm9aI0IOnL0zzo/aiwhVQHj6IABZ9IOMX5jrOebVapXZTBDbULTXYuMmWfECabzAYCCgpgVEpqI3b21ter9dV7dAIEpOruEUPNjfQr9/guAIAPTpiDfMWymQTNhawa0ZUm9BvIeo1iB66FdTod/JF3+uz2ezq1BxqtdpnaLn3Ho9HYzKZPkI+gEmN2Wx+p9Ppnk/N4fX1tR3PtiI6PyKw49YAWu3FZDJhmJcpt4jWS98WckV5WibdxcXFS9j7EbEDGH4UvfX09NTORFGU3l8qlTjCltYA+UK3jUaj37Snrwv/oaSDI50xgH+lPf2RRBwNnHEGVBFg4tnZmYh+7VPfojQWwRr9JjvELGyG0A9pjXLaAbvUx0uIjHp8QL4gREwmk+JfO/KnjEy5u4gAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/709982b7337c907e82909551fcb98e51/a0b58/app9-nats-prometheus-grafana.webp 230w,\n/static/709982b7337c907e82909551fcb98e51/24c94/app9-nats-prometheus-grafana.webp 441w\" sizes=\"(max-width: 441px) 100vw, 441px\" type=\"image/webp\">\n        <source srcset=\"/static/709982b7337c907e82909551fcb98e51/81c8e/app9-nats-prometheus-grafana.png 230w,\n/static/709982b7337c907e82909551fcb98e51/efc6e/app9-nats-prometheus-grafana.png 441w\" sizes=\"(max-width: 441px) 100vw, 441px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/709982b7337c907e82909551fcb98e51/efc6e/app9-nats-prometheus-grafana.png\" alt=\"app9 nats prometheus grafana\" title=\"app9 nats prometheus grafana\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><exercise name='Exercise 4.06: Project v2.0'><p>  Create a new separate service for sending status messages of the todos to a popular chat application. Let's call the new service \"broadcaster\".</p><p>  Requirements:</p><ol>\n<li>The backend saving / updating todos should send a message to NATS</li>\n<li>The broadcaster should subscribe to NATS messages</li>\n<li>The broadcaster should send the message forward to an external service in a format they support</li>\n</ol><p>  Choose either:</p><ul>\n<li>Telegram</li>\n<li>Slack</li>\n<li>Discord</li>\n</ul><p>  or if you don't want to use them use \"Generic\" where an URL is set as an Environment variable and the payload is e.g.</p><div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"user\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"bot\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"message\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"A todo was created\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div><p>  The broadcaster should be able to be scaled without sending the message multiple times. Test that it can run with 6 replicas without issues. The messages only have to be sent to the external service if all of the services are working correctly. So a randomly missing message is not an issue but a duplicate is.</p><p>  Example of a working broadcaster:\n<img src=\"/373b4b99e844fb5340312e7460d81ccf/ex406-solution.gif\"></p><p>  You should not write the API key in plain text.</p></exercise><div><quiz id=\"de114052-aefa-47ca-880c-87f2350a63b6\"></quiz></div></div>","frontmatter":{"path":"/part-4/2-messaging-systems","title":"Messaging Systems"},"fileAbsolutePath":"/Users/matti/dev/kubernetes-hy.github.io/data/part-4/2-messaging-systems.md"},"allPages":{"edges":[{"node":{"id":"fdefbfd6-81fe-562b-98e3-ccae193a91e8","frontmatter":{"path":"/known-problems-solutions","title":"Issues you may face"}}},{"node":{"id":"b1c47f2d-76e9-58d8-9a14-2b6132468171","frontmatter":{"path":"/frontmatter-guide","title":"Frontmatter-guide"}}},{"node":{"id":"12166a9a-6e11-5213-94d8-08c3f18bce09","frontmatter":{"path":"/sanasto","title":"Sanasto"}}},{"node":{"id":"44c243fb-0699-52ee-a2b8-95681b80bfe1","frontmatter":{"path":"/part-3/3-gke-features","title":"GKE features"}}},{"node":{"id":"957e10d7-8115-5f62-8d6a-8046d6a83dab","frontmatter":{"path":"/part-3/4-summary","title":"Summary"}}},{"node":{"id":"e873c4f2-48f2-5265-8a29-233223f3a2e1","frontmatter":{"path":"/part-4/3-gitops","title":"GitOps"}}},{"node":{"id":"6d10a184-73f2-50fe-9846-d93c98783482","frontmatter":{"path":"/part-3","title":"Part 3"}}},{"node":{"id":"d6fe4633-2095-505a-9374-d3713aa920fd","frontmatter":{"path":"/part-4/2-messaging-systems","title":"Messaging Systems"}}},{"node":{"id":"ae51dedf-a0ed-56ed-9043-8d4381286dd5","frontmatter":{"path":"/part-4/1-update-strategies-and-prometheus","title":"Update Strategies and Prometheus"}}},{"node":{"id":"e85ff2b4-7f6c-5a7b-9409-b1b5e26c6b02","frontmatter":{"path":"/part-4/4-summary","title":"Summary"}}},{"node":{"id":"2399333a-4e86-5a72-880d-935a3113f024","frontmatter":{"path":"/part-4","title":"Part 4"}}},{"node":{"id":"0e6f20e1-e40e-5550-ac88-a516d2881edb","frontmatter":{"path":"/part-5/3-service-mesh","title":"Service Mesh"}}},{"node":{"id":"943bc3f1-aa37-5a30-8232-b7fe114261c5","frontmatter":{"path":"/part-5/1-kubernetes-internals","title":"Kubernetes Internals"}}},{"node":{"id":"c25696ec-1bd0-521b-8b74-6a6f86514402","frontmatter":{"path":"/part-5/2-custom-resource-definitions","title":"Custom Resource Definitions"}}},{"node":{"id":"da008aad-9b57-5596-b867-815a42284aa3","frontmatter":{"path":"/part-5/4-beyond-kubernetes","title":"Beyond Kubernetes"}}},{"node":{"id":"13493822-b1dd-5402-a880-ce7945761246","frontmatter":{"path":"/part-5","title":"Part 5"}}},{"node":{"id":"b329e1eb-4475-517c-aacc-00490d0d2839","frontmatter":{"path":"/part-1","title":"Part 1"}}},{"node":{"id":"478f0beb-6ceb-5414-ae92-e25793249bc2","frontmatter":{"path":"/part-2/6-summary","title":"Summary"}}},{"node":{"id":"f52cacfb-80fe-5e11-bf42-3655f4dff267","frontmatter":{"path":"/part-2","title":"Part 2"}}},{"node":{"id":"9d9ca5cf-d405-50f5-b561-f857d2a77c76","frontmatter":{"path":"/","title":"Homepage"}}},{"node":{"id":"020bb076-085d-558c-957d-82654859221a","frontmatter":{"path":"/notes","title":"Notes"}}},{"node":{"id":"342f8ea2-aafe-5193-a678-fb17d3725d32","frontmatter":{"path":"/faq","title":"FAQ"}}},{"node":{"id":"f2603f2a-7d1c-577c-b6ef-cff715589ff2","frontmatter":{"path":"/part-1/1-first-deploy","title":"First Deploy"}}},{"node":{"id":"ae65c6ca-f091-5e34-8e08-1a0c32f5e872","frontmatter":{"path":"/part-1/2-introduction-to-debugging","title":"Introduction to Debugging"}}},{"node":{"id":"6510eba0-b261-5617-9467-bdd7c41e3e66","frontmatter":{"path":"/part-1/3-introduction-to-networking","title":"Introduction to Networking"}}},{"node":{"id":"33a50027-b9c0-5adf-ba80-9517be19aa92","frontmatter":{"path":"/part-1/4-introduction-to-storage","title":"Introduction to Storage"}}},{"node":{"id":"77584bf2-b9d2-5000-9c4e-ffae7142b953","frontmatter":{"path":"/part-1/5-summary","title":"Summary"}}},{"node":{"id":"ef8184fe-25fd-55c7-b2b0-89488dbeda0a","frontmatter":{"path":"/part-2/2-organizing-a-cluster","title":"Organizing a cluster"}}},{"node":{"id":"db3d8354-0a0e-5f48-8fc5-2df668241733","frontmatter":{"path":"/part-2/3-configuring-applications","title":"Configuring applications"}}},{"node":{"id":"3b8b3351-9969-5ac2-b5c8-e8c709eb3382","frontmatter":{"path":"/part-2/4-statefulsets-and-jobs","title":"StatefulSets and Jobs"}}},{"node":{"id":"38fa2dd0-5645-562f-8e0b-eff8542c3117","frontmatter":{"path":"/part-2/5-monitoring","title":"Monitoring"}}},{"node":{"id":"c36d04e4-b166-5cd2-97bf-2d83da8e72fe","frontmatter":{"path":"/part-2/1-networking-between-pods","title":"Networking between pods"}}},{"node":{"id":"e5cdb9b5-2610-5e87-8f36-06d38e72bac4","frontmatter":{"path":"/part-3/2-deployment-pipeline","title":"Deployment Pipeline"}}},{"node":{"id":"24e8849f-09ad-5dc0-ada7-9ee5278ef27b","frontmatter":{"path":"/part-0","title":"Part 0"}}}]}},"pageContext":{}},"staticQueryHashes":["3294351120","994120085"]}